build-job:
  stage: build
  tags: 
    - shell
  script:
    - docker build -t docker-repo.bodc.me/oceaninfo/imfe-pilot/frontend:latest .

deploy-job:
  stage: deploy
  tags:
      - shell
  script:
     #note: we must have done a "docker login docker-repo.bodc.me" manually on the build and web VMs before this pipeline can run
     - docker push docker-repo.bodc.me/oceaninfo/imfe-pilot/frontend:latest
     - ssh web 'docker pull docker-repo.bodc.me/oceaninfo/imfe-pilot/frontend:latest'
# workaround for when we can't access the container registry
#     - docker save docker-repo.bodc.me/colsau/imfe-pilot/frontend | gzip -c - > frontend.tar.gz
#     - scp frontend.tar.gz web:/home/gitlab-runner/
#     - ssh web "gunzip -c frontend.tar.gz | docker load"
     - ssh web 'docker stop frontend && docker container rm frontend && docker run -d -p 8080:80 --name frontend docker-repo.bodc.me/oceaninfo/imfe-pilot/frontend:latest'

trigger-job:
  trigger:
    project: ocean-informatics/imfepilot/frontend_test

